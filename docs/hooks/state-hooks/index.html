<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.64">
<title data-react-helmet="true">State Hooks | Polyhorn</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="State Hooks | Polyhorn"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><meta data-react-helmet="true" property="og:url" content="https://polyhorn.com/docs/hooks/state-hooks"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://polyhorn.com/docs/hooks/state-hooks"><link rel="stylesheet" href="/styles.e4bc6be8.css">
<link rel="preload" href="/styles.7ab95536.js" as="script">
<link rel="preload" href="/runtime~main.29a8f7a6.js" as="script">
<link rel="preload" href="/main.7b2396e6.js" as="script">
<link rel="preload" href="/1.33ca3ca6.js" as="script">
<link rel="preload" href="/2.465f2d5e.js" as="script">
<link rel="preload" href="/71.3d4107a4.js" as="script">
<link rel="preload" href="/72.c4e7951e.js" as="script">
<link rel="preload" href="/935f2afb.0183a429.js" as="script">
<link rel="preload" href="/17896441.cd52523f.js" as="script">
<link rel="preload" href="/a692c9d4.e7bb209e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div class="announcementBar_1Lt-" style="background-color:#ffffff;color:#091E42" role="banner"><div class="announcementBarContent_3XjZ">ðŸš§ Polyhorn is still very much a work-in-progress! ðŸš§</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/emoji-polyhorn.png" alt="Polyhorn Logo"><strong class="navbar__title">Polyhorn</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/api/">API</a><a class="navbar__item navbar__link" href="/components/">Components</a><a class="navbar__item navbar__link" href="/plugins/">Plugins</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/polyhorn/polyhorn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1wyx"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_i4TN">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_i4TN">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/emoji-polyhorn.png" alt="Polyhorn Logo"><strong class="navbar__title">Polyhorn</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/api/">API</a></li><li class="menu__list-item"><a class="menu__link" href="/components/">Components</a></li><li class="menu__list-item"><a class="menu__link" href="/plugins/">Plugins</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/polyhorn/polyhorn" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_3mlj"><div class="docSidebarContainer_3UzP" role="complementary"><div class="sidebar_3at3"><div class="menu menu--responsive menu_5Fix"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_3X9K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Polyhorn</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/why-polyhorn">Why Polyhorn?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/contributing">Contributing</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Concepts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/concepts/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/concepts/components">Components</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/concepts/elements">Elements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/concepts/instances">Instances</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Hooks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hooks/">Overview</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/hooks/state-hooks">State Hooks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hooks/effect-hooks">Effect Hooks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hooks/reference-hooks">Reference Hooks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/hooks/context-hooks">Context Hooks</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Platforms</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/platforms/android">Android</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/platforms/ios">iOS</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Workflow</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ci/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/workflow/editors">Editors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/workflow/ci">Continuous Integration</a></li></ul></li></ul></div></div></div><main class="docMainContainer_7n4f"><div class="container padding-vert--lg docItemWrapper_2WiU"><div class="row"><div class="col docItemCol_soNA"><div class="docItemContainer_3-MX"><article><header><h1 class="docTitle_3qsi">State Hooks</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ebX-" id="overview"></a>Overview<a aria-hidden="true" tabindex="-1" class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>By default, components are pure functions of their properties (i.e. <code>&amp;self</code>).
However, often we want to add some state to components. For example, forms
should be able to save the text that is entered into a text field. The state
hook facilitates this.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ebX-" id="declaration"></a>Declaration<a aria-hidden="true" tabindex="-1" class="hash-link" href="#declaration" title="Direct link to heading">#</a></h2><p>The state hook is declared with a <code>UseState</code> trait. The hook can be used on
any type that implements this trait.</p><div class="mdxCodeBlock_J_5j"><div style="color:#d6deeb;background-color:#011627" class="codeBlockTitle_2WaD">Definition</div><div class="codeBlockContent_2Uwf"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1k8g undefined">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_3JNf codeBlockWithTitle_3beb"><div class="codeBlockLines_1QyP" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">pub trait UseState {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fn use_state&lt;T, F&gt;(&amp;mut self, key: Key, initializer: F) -&gt; State&lt;T&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    where</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        T: Serialize + Deserialize + &#x27;static,</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        F: FnOnce() -&gt; T;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div></div></div><p>It is recommended to use the macro instead of interfacing with the trait
directly. The macro will generate a unique invocation ID and wrap the default
value in a closure so that it is only called during the initial render.</p><div class="mdxCodeBlock_J_5j"><div style="color:#d6deeb;background-color:#011627" class="codeBlockTitle_2WaD">Definition</div><div class="codeBlockContent_2Uwf"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1k8g undefined">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_3JNf codeBlockWithTitle_3beb"><div class="codeBlockLines_1QyP" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">use_state!($manager:expr, $default_value:expr) =&gt; {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    UseState::use_state($manager, use_id!(), || $default_value)</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ebX-" id="usage"></a>Usage<a aria-hidden="true" tabindex="-1" class="hash-link" href="#usage" title="Direct link to heading">#</a></h2><p>The <code>use_state!(...)</code> macro returns a <code>State&lt;T&gt;</code> value. The generic
parameter <code>T</code> is automatically inferred when you use it. For example:</p><div class="mdxCodeBlock_J_5j"><div style="color:#d6deeb;background-color:#011627" class="codeBlockTitle_2WaD">Example</div><div class="codeBlockContent_2Uwf"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1k8g undefined">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_3JNf codeBlockWithTitle_3beb"><div class="codeBlockLines_1QyP" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">let clicked = use_state!(manager, false);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">poly!(</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    &lt;View on_pointer_up={ |_|</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        clicked.replace(true);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    } ... /&gt;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">)</span></div></div></div></div></div><p>In this case, the Rust compiler will automatically infer that <code>clicked</code> is a
<code>State&lt;bool&gt;</code>.</p><p>Keep in mind that (in a future version of Polyhorn) the entire state will be
serialized when the user closes your app. This means that everything you
store in your state, must be serializable. Specifically: don&#x27;t use state to
store WebSockets or API clients.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ebX-" id="api-reference"></a>API Reference<a aria-hidden="true" tabindex="-1" class="hash-link" href="#api-reference" title="Direct link to heading">#</a></h2><p>State objects hold a weak pointer to an entry in the state map of
<a href="/docs/concepts/instances/">an instance</a>. Since it is impossible to obtain a
reference to the instance itself, this eliminates any risk of introducing a
reference cycle.</p><p>However, as a consequence, it is up to the developer to ensure that the state is
no longer used after its corresponding component is unmounted. If any of the
methods are called after the component is unmounted, Polyhorn will <code>panic!</code>.</p><div class="mdxCodeBlock_J_5j"><div style="color:#d6deeb;background-color:#011627" class="codeBlockTitle_2WaD">Definition</div><div class="codeBlockContent_2Uwf"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1k8g undefined">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_3JNf codeBlockWithTitle_3beb"><div class="codeBlockLines_1QyP" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">impl State&lt;T&gt; where T: Serialize + Deserialize {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    /// Replaces the current value with the given value and returns the old</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    /// value afterwards.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    pub fn replace(&amp;self, value: impl Into&lt;T&gt;) -&gt; T;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    /// Clones the current value and returns it.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    pub fn to_owned(&amp;self) -&gt; T::Owned where T: ToOwned;</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ebX-" id="roadmap"></a>Roadmap<a aria-hidden="true" tabindex="-1" class="hash-link" href="#roadmap" title="Direct link to heading">#</a></h2><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>We&#x27;re still working on a better API for state. If you have thoughts, please
let us know on <a href="https://github.com/polyhorn/polyhorn" target="_blank" rel="noopener noreferrer">our Github</a>. For example:</p><ol><li><p>Currently, <code>State&lt;T&gt;</code> is not <code>Copy</code>, which makes it a bit less ergonomic
when passing it to callbacks (since it requires cloning). We might want to
consider an arena-based approach where <code>State&lt;T&gt;</code> simply contains the index
of an instance&#x27;s state entry and requires a manager to obtain a value.</p></li><li><p>Similarly, since state is accessed through a weak pointer and stored in
<code>RefCell</code>s, it&#x27;s not very ergonomic to obtain a reference to its value.
Specifically: we can&#x27;t return the <code>RefCell</code>&#x27;s <code>RefMut</code> since its lifetime is
tied to the weak pointer&#x27;s upgrade, which is bound to the accessor function:</p><div class="mdxCodeBlock_J_5j"><div class="codeBlockContent_2Uwf"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1k8g">Copy</button><div tabindex="0" class="prism-code language-rust codeBlock_3JNf"><div class="codeBlockLines_1QyP" style="color:#d6deeb;background-color:#011627"><div class="token-line" style="color:#d6deeb"><span class="token plain">impl State&lt;T&gt; {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    // Hypothetical implementation of `get_mut`.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    fn get_mut(&amp;self) -&gt; RefMut&lt;&#x27;_, T&gt; {</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // Upgrade the weak pointer to a strong pointer.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        let instance: Rc&lt;Instance&gt; = self.weak.upgrade().unwrap();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // Obtain the state&#x27;s entry.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        let entry: &amp;&#x27;instance RefCell&lt;T&gt; = instance.state.get(&amp;self.key);</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // Borrow its value mutably.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        let borrow: BorrowMut&lt;&#x27;entry, T&gt; = entry.borrow_mut();</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // ERR: the borrow is tied to the entry, which is tied to the</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        // instance, which is dropped once we return.</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">        borrow</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">    }</span></div><div class="token-line" style="color:#d6deeb"><span class="token plain">}</span></div></div></div></div></div></li><li><p><code>State&lt;T&gt;</code> should be valid during its entire lifetime: it should never panic.
This could potentially be solved as a consequence of 1).</p></li></ol></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/polyhorn/polyhorn.github.io/edit/master/docs/general/hooks/state.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/hooks/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Hooks</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/hooks/effect-hooks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Effect Hooks Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3Ewg"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#declaration" class="table-of-contents__link">Declaration</a></li><li><a href="#usage" class="table-of-contents__link">Usage</a></li><li><a href="#api-reference" class="table-of-contents__link">API Reference</a></li><li><a href="#roadmap" class="table-of-contents__link">Roadmap</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Concepts</a></li><li class="footer__item"><a class="footer__link-item" href="/api/">API Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/components/">Components</a></li><li class="footer__item"><a class="footer__link-item" href="/plugins/">Plugins</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/polyhorn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/polyhorn/polyhorn" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 Glacyr B.V. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.7ab95536.js"></script>
<script src="/runtime~main.29a8f7a6.js"></script>
<script src="/main.7b2396e6.js"></script>
<script src="/1.33ca3ca6.js"></script>
<script src="/2.465f2d5e.js"></script>
<script src="/71.3d4107a4.js"></script>
<script src="/72.c4e7951e.js"></script>
<script src="/935f2afb.0183a429.js"></script>
<script src="/17896441.cd52523f.js"></script>
<script src="/a692c9d4.e7bb209e.js"></script>
</body>
</html>